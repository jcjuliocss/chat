<!DOCTYPE html>
<html>
<head>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.dev.js"></script>
	<script src="https://code.jquery.com/jquery-3.4.1.js" integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU=" crossorigin="anonymous"></script>
	<script type="text/javascript">
		socket = io.connect('https://chat-socketio-test.herokuapp.com/', {transports: ['websocket']})

		socket.on('connect', function() {
			socket.emit('my event', {
				data: 'Usu√°rio conectado.'
			})
		})

		socket.on('message', function(msg) {
			div = document.createElement("div")
			div.setAttribute("style", "width: max-content; height: auto;")
			li = document.createElement("li")
			if(typeof msg.nome == 'undefined'){
				txt_node = document.createTextNode(msg.data)
			}else{
				txt_node = document.createTextNode(msg.nome + ' diz: ' + msg.texto)
				txt_hr_node = document.createTextNode(msg.horario)
				span = document.createElement("span")
				span.setAttribute("style", "float: right; font-size: 10px; color: gray;")
				span.appendChild(txt_hr_node)
				br = document.createElement("br")
			}
			li.appendChild(txt_node)
			div.appendChild(li)
			if(typeof msg.nome != 'undefined'){
				div.appendChild(span)
				div.appendChild(br)
			}
			document.getElementById("msgs").appendChild(div)
		})

		function enviar_mensagem(){
			texto_mensagem = document.getElementById("mensagem")
			texto_nome = document.getElementById("nome")
			socket.emit( 'my event', {
				nome: texto_nome.value,
				texto: texto_mensagem.value
			})
			texto_mensagem.value = ''
		}

		function atualiza_tamanho(){
			caracteres_restantes = document.getElementById("caracteres_restantes")
			limite = 300
			tamanho_texto = document.getElementById("mensagem").value.length
			total_restantes = limite - tamanho_texto
			caracteres_restantes.innerHTML = (total_restantes + " restantes").toString()
		}

		function testa_envio(e){
			if (e.key == 'Enter') {
				enviar_mensagem()
				atualiza_tamanho()
			}
		}
	</script>
</head>
<body>
	<ul id="msgs"></ul>
	<input type="text" name="nome" placeholder="nome" id="nome"><br>
	<div style="width: 297px;">
		<textarea maxlength="300" rows="5" cols="40" name="mensagem" id="mensagem" placeholder="mensagem" onkeyup="atualiza_tamanho(); testa_envio(event)" onkeydown="atualiza_tamanho()"></textarea><br>
		<font size="2" style="float: right;"><span id="caracteres_restantes">300 restantes</span></font><br>
	</div>
	<button id="enviar" onclick="enviar_mensagem(); atualiza_tamanho()">Enviar(Enter)</button>
</body>
</html>